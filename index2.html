<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Canvas Game with Joystick</title>

  <style>
   /* make body full-width, remove default margins */
body, html {
  margin: 0;
  padding: 0;
  overflow: hidden;
  user-select: none;
}

/* center and limit game area to 600px */
#game-area {
  width: 100%;
  max-width: 600px;
  margin: 20px auto;
  position: relative;
}

/* full-width canvas */
#game-area canvas {
  width: 100%;
  height: auto;
  display: block;
  background: #eef;
}

/* restart button centered over canvas */
#restart {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  display: none;
  padding: 10px 20px;
  font-size: 18px;
  z-index: 10;
}

/* joystick wrapper centers the control below the canvas */
#joystick-wrapper {
  width: 100%;
  max-width: 600px;
  margin: 10px auto;
  text-align: center;
}

/* joystick base: inline-block, no absolute positioning */
#joystick-container {
  display: inline-block;
  width: 240px;
  height: 240px;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.25);
  touch-action: none;
  position: relative;
  overflow: hidden;
}

/* thumb remains absolutely positioned within its base */
#joystick-thumb {
  position: absolute;
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.5);
  left: calc(50% - 40px);
  top:  calc(50% - 40px);
  transition: top 0.1s, left 0.1s;
}

  </style>
</head>

<body>
  <div id="game-area">
    <canvas id="canvas" width="600" height="400"></canvas>
    <button id="restart">Restart</button>
  </div>

  <!-- Joystick goes here, below the canvas -->
  <div id="joystick-wrapper">
    <div id="joystick-container">
      <div id="joystick-thumb"></div>
    </div>
    <h2>Joystick</h2>
  </div>

  <script>
    window.onload = function() {
      const canvas  = document.getElementById("canvas");
      const context = canvas.getContext("2d");
      const restart = document.getElementById("restart");

      let x = 250, y = 150, vx = 0, vy = 0;
      const acceleration = 2200;
      const friction     = 0.9;
      let coinx = Math.random() * (600 - 70);
      let coiny = Math.random() * (400 - 70);
      let bomx = Math.random() * (600 - 70);
      let bomy = -100;
      let bombActivated = false;
      let gameOver      = false;
      let score         = 0;
      let t             = Date.now();

      // Images & Audio
      const playerImg = new Image();
      const coinImg   = new Image();
      const bombImg   = new Image();
      playerImg.src = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS2oP3lWLmezhBAmuHvAwuaqRv6xVX0eApt7A&s';
      coinImg.src   = 'https://www.partysuppliesindia.com/cdn/shop/products/1_36_9f92dde3-d77d-4459-a21f-63744a94c836.jpg?v=1735574298&width=1500';
      bombImg.src   = 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSrhGLUu7GF58R8WurYsZXGRwPSg1aER4LGrw&s';

      const bgMusic   = new Audio('background.mp3');
      const coinSound = new Audio('foodeat.mp3');
      bgMusic.loop   = true;
      bgMusic.volume = 0.2;
      bgMusic.play().catch(() => {
        document.body.addEventListener('click', () => bgMusic.play(), { once: true });
      });

      // Keyboard state
      const keys = {};
      document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
      document.addEventListener("keyup",   e => keys[e.key.toLowerCase()] = false);

      // Joystick state
      let joyX = 0, joyY = 0;
      const stickRadius = 240 / 2;
      const thumb       = document.getElementById("joystick-thumb");
      const base        = document.getElementById("joystick-container");

      function onStart(e) {
        e.preventDefault();
      }
      function onMove(e) {
        const touch = e.touches[0];
        const rect  = base.getBoundingClientRect();
        let dx = touch.clientX - (rect.left + stickRadius);
        let dy = touch.clientY - (rect.top  + stickRadius);

        const dist = Math.hypot(dx, dy);
        const max  = stickRadius - 40;
        if (dist > max) {
          dx = (dx/dist) * max;
          dy = (dy/dist) * max;
        }

        // thumb.style.left = \`\${stickRadius + dx - 40}px\`;
        // thumb.style.top  = \`\${stickRadius + dy - 40}px\`;

        thumb.style.left = `${stickRadius + dx - 40}px`;
        thumb.style.top  = `${stickRadius + dy - 40}px`;


        joyX = dx / max;
        joyY = dy / max;
      }
      function onEnd() {
        thumb.style.left = "calc(50% - 40px)";
        thumb.style.top  = "calc(50% - 40px)";
        joyX = 0; joyY = 0;
      }

      base.addEventListener("touchstart",  onStart, { passive:false });
      base.addEventListener("touchmove",   onMove,  { passive:false });
      base.addEventListener("touchend",    onEnd );
      base.addEventListener("touchcancel", onEnd );

      restart.onclick = () => {
        score = 0;
        x = 250; y = 150; vx = 0; vy = 0;
        coinx = Math.random() * (600 - 70);
        coiny = Math.random() * (400 - 70);
        bomx = 0; bomy = -100;
        bombActivated = false;
        gameOver      = false;
        restart.style.display = "none";
        t = Date.now();
        draw();
      };

      function updateVelocity(dt) {
        // arrow/WASD
        if (keys["arrowright"] || keys["d"]) vx += acceleration * dt;
        if (keys["arrowleft"]  || keys["a"]) vx -= acceleration * dt;
        if (keys["arrowdown"]  || keys["s"]) vy += acceleration * dt;
        if (keys["arrowup"]    || keys["w"]) vy -= acceleration * dt;

        // joystick
        vx += joyX * acceleration * dt;
        vy += joyY * acceleration * dt;

        vx *= friction;
        vy *= friction;
        x  += vx * dt;
        y  += vy * dt;

        x = Math.max(0, Math.min(600 - 100, x));
        y = Math.max(0, Math.min(400 - 100, y));
      }

      function draw() {
        let dt = (Date.now() - t) / 1000;
        t = Date.now();
        updateVelocity(dt);

        context.clearRect(0, 0, 600, 400);
        context.font = '25px Arial';
        context.fillStyle = 'black';
        context.fillText("Score: " + score, 20, 30);

        // bomb activation after 5 coins
        if (score >= 5) {
          if (!bombActivated) {
            bomx = Math.random() * (600 - 70);
            bomy = -100;
            bombActivated = true;
          }
          context.drawImage(bombImg, bomx, bomy, 70, 70);
          bomy += 3;
          if (bomy >= 600) {
            bomx = Math.random() * (600 - 70);
            bomy = -100;
          }
          if (
            bomx <= x + 100 && x <= bomx + 70 &&
            bomy <= y + 100 && y <= bomy + 70
          ) {
            gameOver = true;
            restart.style.display = "block";
          }
        }

        context.drawImage(playerImg, x, y, 100, 100);
        context.drawImage(coinImg, coinx, coiny, 70, 70);

        // collect coin
        if (
          coinx <= x + 100 && x <= coinx + 70 &&
          coiny <= y + 100 && y <= coiny + 70
        ) {
          score++;
          coinSound.currentTime = 0;
          coinSound.play();
          setTimeout(() => {
            coinSound.pause();
            coinSound.currentTime = 0;
          }, 3000);
          coinx = Math.random() * (600 - 70);
          coiny = Math.random() * (400 - 70);
        }

        if (gameOver) {
          context.fillStyle = "rgba(0, 0, 0, 0.7)";
          context.fillRect(0, 0, 600, 400);
          context.fillStyle = "white";
          context.font = "90px Arial";
          context.textAlign = "center";
          context.fillText("Game Over", 300, 200);
          return;
        }

        requestAnimationFrame(draw);
      }

      playerImg.onload = () => draw();
    };
  </script>
</body>
</html>
